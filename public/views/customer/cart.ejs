<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/customer/cart.css">
    <link rel="shortcut icon" href="../img/logo/favico.png" type="image/x-icon">
    <title>ตะกร้าสินค้า</title>
</head>

<body>
    <header>
        <a href="/" class="logo"><img src="../img/logo/logo_store.png" alt="logo"></a>

        <form class="search-bar" action="/search" method="GET">
            <input type="text" name="query" placeholder="ค้นหาสินค้า..." />
            <button type="submit">ค้นหา</button>
        </form>

        <nav>
            <div><a href="/">หน้าแรก</a></div>
            <div class="dropdown">
                <a href="/category" class="dropbtn">หมวดหมู่</a>
                <div class="dropdown-content">
                    <% for(var i=0; i< category.length; i++) { %>
                        <a href="/category/<%=category[i].category_name%>"><%= category[i].name %></a>
                    <% } %>
                </div>
            </div>
            <div><a href="/cart">ตะกร้า</a></div>
            <% if (loginSession) { %>
                <div><a href="/account">ข้อมูลส่วนตัว</a></div>
            <% } else { %>
                <div><a href="/signin">เข้าสู่ระบบ</a></div>
            <% } %>
        </nav>
    </header>

    <div class="banner"></div>

    <div class="container">
        <h1 class="section-title">ตะกร้าสินค้า</h1>

        <div class="cart-items">
            <table class="data">
                <thead>
                    <tr>
                        <th>ภาพสินค้า</th>
                        <th>ชื่อสินค้า</th>
                        <th>ราคา/ชิ้น</th>
                        <th>จำนวน</th>
                        <th>ราคารวม</th>
                        <th>ลบ</th> <!-- เพิ่มคอลัมน์สำหรับปุ่มลบ -->
                    </tr>
                </thead>
                <tbody>
                    <% let totalPrice = 0; %> <!-- ประกาศ totalPrice แค่ครั้งเดียวที่นี่ -->
                    <% cartItem.forEach(product => { %>
                        <% 
                            const brandName = brands.find(brand => brand.brand_ID == product.Product.brand_ID); 
                            const itemTotal = product.quantity * product.Product.unitPrice;
                            totalPrice += itemTotal; // คำนวณผลรวมของตะกร้า
                        %>
                        <tr id="row-<%= product.Product.product_ID %>">
                            <td>
                                <a href="/detail?brand=<%= brandName.name %>&Id=<%= product.Product.product_ID %>">
                                    <img src="../../img/product/Major-cineplex-logo.png" alt="Product Image" class="cart-item-image">
                                </a>
                            </td>
                            <td>
                                <h2><%= brandName ? `${brandName.name} ${product.Product.name}` : product.Product.name %></h2>
                            </td>
                            <td><h3 id="price-<%= product.Product.product_ID %>"><%= parseFloat(product.Product.unitPrice).toFixed(2) %> บาท</h3></td>
                            <td>
                                <button type="button" onclick="updateQuantity('<%= product.Product.product_ID %>', -1)">-</button>
                                <span id="quantity-<%= product.Product.product_ID %>"><%= product.quantity %></span>
                                <button type="button" onclick="updateQuantity('<%= product.Product.product_ID %>', 1)">+</button>
                            </td>
                            <td><h3><span id="total-<%= product.Product.product_ID %>"><%= itemTotal.toFixed(2) %> บาท</span></h3></td>
                            <td>
                                <button type="button" onclick="deleteItem('<%= product.Product.product_ID %>')">ลบ</button>
                            </td>
                            
                        </tr>
                    <% }); %>
                </tbody>
            </table>
            <div class="cart-summary">
                <h3>ราคารวมทั้งหมด: <span id="all"><%= totalPrice.toFixed(2) %> บาท</span></h3>
                <a href="/checkout" class="checkout-btn">
                    <button type="button">ชำระเงิน</button>
                </a>
            </div>
        </div>
    </div>

    <footer>
        &copy; 2025 DIY Computer | สงวนลิขสิทธิ์
    </footer>

    <script>
        // ฟังก์ชันอัปเดตจำนวนสินค้า
        function updateQuantity(productId, change) {
            const quantityElement = document.getElementById(`quantity-${productId}`);
            const totalElement = document.getElementById(`total-${productId}`);
            let quantity = parseInt(quantityElement.innerText);

            // เปลี่ยนแปลงจำนวนสินค้า
            quantity += change;
            if (quantity < 1) quantity = 1; // ห้ามให้จำนวนต่ำกว่า 1

            // อัปเดตจำนวน
            quantityElement.innerText = quantity;

            // อัปเดตราคารวมของสินค้า
            const price = parseFloat(document.getElementById(`price-${productId}`).innerText);
            totalElement.innerText = (price * quantity).toFixed(2) + " บาท";

            // คำนวณผลรวมทั้งหมด
            updateTotalPrice();
        }

        // ฟังก์ชันคำนวณผลรวมทั้งหมด
        function updateTotalPrice() {
            let totalPrice = 0;

            // คำนวณผลรวมทั้งหมดจากทุกสินค้าที่อยู่ในตะกร้า
            const allTotalElements = document.querySelectorAll('[id^="total-"]');
            allTotalElements.forEach((totalElement) => {
                const itemTotal = parseFloat(totalElement.innerText.replace(' บาท', ''));
                totalPrice += itemTotal;
            });

            // อัปเดตราคารวมทั้งหมด
            document.getElementById('all').innerText = totalPrice.toFixed(2) + " บาท";
        }

        // ฟังก์ชันลบสินค้าออกจากตะกร้า
        // ฟังก์ชันลบสินค้าออกจากตะกร้า
        async function deleteItem(productId) 
        {
            if (!confirm('คุณแน่ใจหรือไม่ว่าต้องการลบสินค้านี้?')) return;

            try {
                const response = await fetch(`/deleteItem?id=${productId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    // ลบสินค้าจาก DOM
                    const row = document.getElementById(`row-${productId}`);
                    row.remove();

                    // อัปเดตราคารวมทั้งหมด
                    updateTotalPrice();
                } else {
                    alert('เกิดข้อผิดพลาดในการลบสินค้า');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์');
            }
        }


    </script>

</body>

</html>
