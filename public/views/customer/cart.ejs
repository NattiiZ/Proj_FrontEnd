<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/customer/cart.css">
    <link rel="shortcut icon" href="../img/logo/favico.png" type="image/x-icon">
    <title>ตะกร้าสินค้า</title>
</head>

<body>
    <header>
        <a href="/" class="logo"><img src="../img/logo/logo_store.png" alt="logo"></a>

        <form class="search-bar" action="/search" method="GET">
            <input type="text" name="query" placeholder="ค้นหาสินค้า..." />
            <button type="submit">ค้นหา</button>
        </form>

        <nav>
            <div><a href="/">หน้าแรก</a></div>
            <div class="dropdown">
                <a href="/category" class="dropbtn">หมวดหมู่</a>
                <div class="dropdown-content">
                    <% for(var i=0; i< category.length; i++) { %>
                        <a href="/category/<%=category[i].category_name%>"><%= category[i].name %></a>
                    <% } %>
                </div>
            </div>
            <div><a href="/cart">ตะกร้า</a></div>
            <% if (loginSession) { %>
                <div><a href="/account">ข้อมูลส่วนตัว</a></div>
            <% } else { %>
                <div><a href="/signin">เข้าสู่ระบบ</a></div>
            <% } %>
        </nav>
    </header>


    <div class="container">
        <h1 class="section-title">ตะกร้าสินค้า</h1>
        
        <% if (cartItem.length > 0) { %>
            <div class="cart-items">
                <table class="data">
                    <thead>
                        <tr>
                            <th></th>
                            <th id="name">ชื่อสินค้า</th>
                            <th>ราคา/ชิ้น</th>
                            <th>จำนวน</th>
                            <th id="price">ราคารวม</th>
                            <th></th> <!-- เพิ่มคอลัมน์สำหรับปุ่มลบ -->
                        </tr>
                    </thead>
                    <tbody>
                        <% let totalPrice = 0; %> <!-- ประกาศ totalPrice แค่ครั้งเดียวที่นี่ -->
                        <% cartItem.forEach(product => { %>
                            <% 
                                const brandName = brands.find(brand => brand.brand_ID == product.Product.brand_ID); 
                                const itemTotal = product.quantity * product.Product.unitPrice;
                                totalPrice += itemTotal; // คำนวณผลรวมของตะกร้า
                            %>
                            <tr id="row-<%= product.Product.product_ID %>">
                                <td>
                                    <a href="/detail?brand=<%= brandName.name %>&Id=<%= product.Product.product_ID %>">
                                        <img src="../../img/product/Major-cineplex-logo.png" alt="Product Image" class="cart-item-image">
                                    </a>
                                </td>
                                <td>
                                    <h2><%= brandName ? `${brandName.name} ${product.Product.name}` : product.Product.name %></h2>
                                </td>
                                <td><h3 id="price-<%= product.Product.product_ID %>"><%= parseFloat(product.Product.unitPrice).toFixed(2) %></h3></td>
                                <td class="edit">
                                    <button type="button" onclick="updateQuantity('<%= product.Product.product_ID %>', -1)">-</button>
                                    <span id="quantity-<%= product.Product.product_ID %>"><%= product.quantity %></span>
                                    <button type="button" onclick="updateQuantity('<%= product.Product.product_ID %>', 1)">+</button>
                                </td>
                                <td><h3><span id="total-<%= product.Product.product_ID %>"><%= itemTotal.toFixed(2) %></span></h3></td>
                                <td>
                                    <button id="del-Btn" type="button" onclick="deleteItem('<%= cartId %>', '<%= product.Product.product_ID %>')">X</button>
                                </td>
                                
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
                <div class="cart-summary">
                    <h3>ราคารวมสุทธิ : <span id="all"><%= totalPrice.toFixed(2) %> บาท</span></h3>
                    <a href="javascript:void(0);" class="checkout-btn">
                        <button type="button" onclick="checkOut('<%= cartId %>')">ชำระเงิน</button>
                    </a>
                </div>
            </div>
        <% } else { %>
            <div class="cart-summary">
                <h3>ราคารวมสุทธิ : 0.00 บาท</span></h3>
                <h2>ไม่มีสินค้าในตะกร้า</h2>
            </div>
        <% }%>
    </div>

    <footer>
        &copy; 2025 The Computer Store | Copyright
    </footer>

    <script>
        // ฟังก์ชันอัปเดตจำนวนสินค้า
        async function updateQuantity(productId, change) 
        {
            const quantityElement = document.getElementById(`quantity-${productId}`);
            const totalElement = document.getElementById(`total-${productId}`);
            let quantity = parseInt(quantityElement.innerText);

            // เปลี่ยนแปลงจำนวนสินค้า
            quantity += change;
            if (quantity < 1) quantity = 1;

            // อัปเดตจำนวน
            quantityElement.innerText = quantity;

            // อัปเดตราคารวมของสินค้า
            const price = parseFloat(document.getElementById(`price-${productId}`).innerText);
            totalElement.innerText = (price * quantity).toFixed(2) + " บาท";

            // อัปเดตผลรวมทั้งหมด
            updateTotalPrice();

            // ส่งข้อมูลการเปลี่ยนแปลงไปยังเซิร์ฟเวอร์
            // try {
            //     const cartId = document.getElementById('cartId').value; // Assuming you have cartId available in the page
            //     const response = await fetch(`/updateQty`, {
            //         method: 'POST',
            //         headers: {
            //             'Content-Type': 'application/json',
            //         },
            //         body: JSON.stringify({
            //             cartId: cartId,
            //             productId: productId,
            //             quantity: quantity,
            //         }),
            //     });

            //     const result = await response.json();
            //     if (result.success) {
            //         console.log('Quantity updated successfully');
            //     } else {
            //         alert('เกิดข้อผิดพลาดในการอัปเดตจำนวนสินค้า');
            //     }
            // } catch (error) {
            //     console.error('Error:', error);
            //     alert('เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์');
            // }
        }

        function updateTotalPrice() {
            let totalPrice = 0;

            const allTotalElements = document.querySelectorAll('[id^="total-"]');
            allTotalElements.forEach((totalElement) => {
                const itemTotal = parseFloat(totalElement.innerText.replace(' บาท', ''));
                totalPrice += itemTotal;
            });

            document.getElementById('all').innerText = totalPrice.toFixed(2) + " บาท";
        }

        // ฟังก์ชันลบสินค้า
        async function deleteItem(cartId, productId) 
        {
            if (!confirm('ต้องการลบสินค้านี้หรือไม่')) return;

            try {
                const response = await fetch(`/deleteItem?id=${cartId}&item=${productId}`, { method: 'POST' });

                location.reload();
            } 
            catch (error) {
                console.error('Error:', error);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์');
                location.reload();
            }
        }

        // ฟังก์ชันลบสินค้าทั้งหมดจากตะกร้า
        async function checkOut(cartId) 
        {
            if (!confirm('ยืนยันการชำระเงินหรือไม่')) return;

            try {
                const response = await fetch(`/checkOut?cart=${cartId}`, { method: 'POST' });

                alert('ชำระเงินเสร็จเรียบร้อย');

                location.reload();
            } 
            catch (error) {
                console.error('Error:', error);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์');
                location.reload();
            }
        }



    </script>

</body>

</html>
