<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/customer/cart.css">
    <link rel="shortcut icon" href="../img/logo/favico.png" type="image/x-icon">
    <title>ตะกร้าสินค้า</title>
</head>

<body>
    <header>
        <a href="/" class="logo"><img src="../img/logo/logo_store.png" alt="logo"></a>
        <form class="search-bar" action="/search" method="GET">
            <input type="text" name="query" placeholder="ค้นหาสินค้า...">
            <button type="submit">ค้นหา</button>
        </form>
        <nav>
            <a href="/">หน้าแรก</a>
            <a href="/category">หมวดหมู่</a>
            <a href="/cart">ตะกร้า</a>
            <% if (loginSession) { %>
                <a href="/account">ข้อมูลส่วนตัว</a>
            <% } else { %>
                <a href="/signin">เข้าสู่ระบบ</a>
            <% } %>
        </nav>
    </header>

    <div class="container">
        <h1 class="section-title">ตะกร้าสินค้าของคุณ</h1>

        <% let totalPrice = 0; %>

        <div class="cart-items">
            <% if (cartItem.length > 0) { %>
                <table class="data">
                    <thead>
                        <tr>
                            <th>ภาพสินค้า</th>
                            <th>ชื่อสินค้า</th>
                            <th>ราคา/ชิ้น</th>
                            <th>จำนวน</th>
                            <th>ราคารวม</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% cartItem.forEach(product => { %>
                            <% 
                                const brandName = brands.find(brand => brand.brand_ID == product.Product.brand_ID); 
                                const itemTotal = product.quantity * product.Product.unitPrice;
                                totalPrice += itemTotal;
                            %>
                            <tr>
                                <td>
                                    <a href="/detail?brand=<%= brandName.name %>&Id=<%= product.Product.product_ID %>">
                                        <img src="../../img/product/Major-cineplex-logo.png" alt="Product Image" class="cart-item-image">
                                    </a>
                                </td>
                                <td>
                                    <h2><%= brandName ? `${brandName.name} ${product.Product.name}` : product.Product.name %></h2>
                                </td>
                                <td><h3 id="price-<%= product.Product.product_ID %>"><%= parseFloat(product.Product.unitPrice).toFixed(2) %> บาท</h3></td>
                                <td>
                                    <button type="button" onclick="updateQuantity('<%= product.Product.product_ID %>', -1)">-</button>
                                    <span id="quantity-<%= product.Product.product_ID %>"><%= product.quantity %></span>
                                    <button type="button" onclick="updateQuantity('<%= product.Product.product_ID %>', 1)">+</button>
                                </td>
                                <td><h3><span id="total-<%= product.Product.product_ID %>"><%= itemTotal.toFixed(2) %> บาท</span></h3></td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            <% } else { %>
                <p>ไม่มีสินค้าในตะกร้าของคุณ</p>
            <% } %>
        </div>

        <% if (cartItem.length > 0) { %>
            <div class="cart-summary">
                <p>ราคารวมทั้งหมด: <span id="total-price"><%= totalPrice.toFixed(2) %> บาท</span></p>
                <a href="/checkout" class="btn">ชำระเงิน</a>
            </div>
        <% } %>
    </div>

    <script>
        // ฟังก์ชันอัปเดตจำนวนสินค้า
        function updateQuantity(productId, change) {
            const quantityElement = document.getElementById(`quantity-${productId}`);
            const totalElement = document.getElementById(`total-${productId}`);
            let quantity = parseInt(quantityElement.innerText);

            // เปลี่ยนแปลงจำนวนสินค้า
            quantity += change;
            if (quantity < 1) quantity = 1; // ห้ามให้จำนวนต่ำกว่า 1

            // อัปเดตจำนวน
            quantityElement.innerText = quantity;

            // อัปเดตราคารวมของสินค้า
            const price = parseFloat(document.getElementById(`price-${productId}`).innerText);
            totalElement.innerText = (price * quantity).toFixed(2) + " บาท";

            // คำนวณผลรวมทั้งหมด
            updateTotalPrice();
        }

        // ฟังก์ชันคำนวณผลรวมทั้งหมด
        function updateTotalPrice() {
            let totalPrice = 0;

            // คำนวณผลรวมทั้งหมดจากทุกสินค้าที่อยู่ในตะกร้า
            <% cartItem.forEach(product => { %>
                const quantity = parseInt(document.getElementById(`quantity-<%= product.Product.product_ID %>`).innerText);
                const price = parseFloat(document.getElementById(`price-<%= product.Product.product_ID %>`).innerText);
                totalPrice += price * quantity;
            <% }); %>

            // อัปเดตผลรวม
            document.getElementById('total-price').innerText = totalPrice.toFixed(2) + " บาท";
        }
    </script>
</body>

<footer>
    &copy; 2025 DIY Computer | สงวนลิขสิทธิ์
</footer>

</html>